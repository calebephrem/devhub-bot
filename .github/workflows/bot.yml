name: DevHub Bot

on:
  workflow_call:
    inputs:
      thank_you_message:
        required: false
        default: 'Thank you for opening this PR! Repo maintainers will review it ASAP ðŸš€'
        type: string

      merge_thank_you_message:
        required: false
        default: 'ðŸŽ‰ Thank you for contributing! We really appreciate your work.'
        type: string

      cc_warning_message:
        required: false
        default: "âš ï¸ Please consider using Conventional Commits (e.g. feat:, fix:, docs:).\nhttps://www.conventionalcommits.org/en/v1.0.0/"
        type: string

    secrets:
      DEVHUB_APP_ID:
        required: true
      DEVHUB_APP_PRIVATE_KEY:
        required: true

jobs:
  pr-handler:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Generate DevHub Bot token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Fetch PR commits
        id: commits
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              }
            );
            core.setOutput(
              "messages",
              JSON.stringify(commits.map(c => c.commit.message))
            );

      - name: Analyze PR title & commits
        id: analyze
        run: |
          echo '${{ steps.commits.outputs.messages }}' > commits.json

          FOUND=false
          LABELS=""
          PR_TITLE="${{ github.event.pull_request.title }}"

          regex='^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:\ .+'

          if [[ "$PR_TITLE" =~ $regex ]]; then
            TYPE=$(echo "$PR_TITLE" | sed -E 's/^([a-z]+).*/\1/')
            LABELS="$LABELS $TYPE"
            FOUND=true
          fi

          while read -r msg; do
            if [[ "$msg" =~ $regex ]]; then
              TYPE=$(echo "$msg" | sed -E 's/^([a-z]+).*/\1/')
              LABELS="$LABELS $TYPE"
              FOUND=true
            fi
          done < <(jq -r '.[]' commits.json)

          LABELS=$(echo "$LABELS" | tr ' ' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')

          echo "pass=$FOUND" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Apply labels
        if: steps.analyze.outputs.labels != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: "${{ steps.analyze.outputs.labels }}".split(",")
            });

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const body =
              "${{ steps.analyze.outputs.pass }}" === "true"
                ? `${{ inputs.thank_you_message }}`
                : `${{ inputs.cc_warning_message }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

      - name: Super Linter (non-blocking)
        continue-on-error: true
        uses: super-linter/super-linter@v8.4.0
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_JAVASCRIPT_PRETTIER: true
          VALIDATE_TYPESCRIPT_PRETTIER: true

  pr-merged:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true

    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Thank contributor
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `${{ inputs.merge_thank_you_message }}`
            });

  issue-opened:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Handle issue open (labels + comment)
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const issue = context.payload.issue;

            const text = `${issue.title}\n${issue.body ?? ""}`.toLowerCase();

            const rules = [
              { label: "bug", keywords: ["bug", "error", "crash", "fail", "issue"] },
              { label: "enhancement", keywords: ["feature", "request", "enhance"] },
              { label: "documentation", keywords: ["docs", "readme", "documentation"] },
              { label: "question", keywords: ["question", "help"] },
            ];

            const labels = rules
              .filter(r => r.label && r.keywords.some(k => text.includes(k)))
              .map(r => r.label)
              .filter(l => typeof l === "string" && l.trim().length > 0);

            if (labels.length > 0) {
              console.log("Applying labels:", labels);

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels,
              });
            } else {
              console.log("No labels detected â€” skipping label API call");
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                "ðŸ‘‹ **Thanks for opening this issue!**",
                "",
                "Our maintainers have been notified and will review it as soon as possible ðŸš€",
                "",
                "ðŸ“Œ **To help us resolve this faster:**",
                "- Include clear steps to reproduce (for bugs)",
                "- Mention expected vs actual behavior",
                "- Add screenshots or logs if relevant",
                "",
                "Thanks for contributing to **Open DevHub** ðŸ’™",
              ].join("\n"),
            });
